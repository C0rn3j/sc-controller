version: 1

script:
  - |
    set -eu

    if [ "{{APPIMAGE_SOURCE}}" != "${TARGET_APPDIR}" ]; then
      mv "{{APPIMAGE_SOURCE}}" "${TARGET_APPDIR}"
    fi

    # Manual installation of squashfs-tools is required
    # until https://github.com/AppImageCrafters/build-appimage/issues/5 is fixed
    if ! command -v mksquashfs >/dev/null; then
      apt-get update && apt-get install -y --no-install-recommends squashfs-tools
    fi

AppDir:
  app_info:
    id: org.c0rn3j.sc-controller
    name: sc-controller
    version: "{{APPIMAGE_VERSION}}"
    icon: sc-controller
    exec: usr/bin/python3
    exec_args: -c "import os, sys; os.execvp('$APPDIR/usr/bin/scc', ['$APPDIR/usr/bin/scc'] + (sys.argv[1:] if len(sys.argv) > 1 else ['gui']))" $@

  after_bundle: |
    set -eu

    # appimage-builder expects .desktop file to start with appinfo-id
    desktop="$(find "${TARGET_APPDIR}/usr" -name sc-controller.desktop)"
    sed -i "s:Exec=.*:Exec=./usr/bin/scc gui:g" "${desktop}"
    ln -sr "${desktop}" "${TARGET_APPDIR}/usr/share/applications/org.c0rn3j.sc-controller.desktop"

    # appimage-builder expects utf-8 encoding when patching shebangs,
    # but pygettext3 has iso-8859-1 encoding
    find "${TARGET_APPDIR}/usr/bin" -name 'pygettext*' | while read -r file; do
      encoding="ISO-8859-1"
      if file -bi "${file}" | grep -iq "${encoding}"; then
        <"${file}" iconv -f "${encoding}" -t utf-8 -o "${file}"
        sed -i -E '1,2 s|^(\s*#.*coding[=:]\s*)([[:alnum:].-]+)|\1utf-8|g' "${file}"
      fi
    done

  after_runtime: |
    set -eu

    # python3 is linked against 'lib64/ld-linux-x86-64.so.2'
    # but 'compat/lib64' is missing for Ubuntu Noble
    compat="${TARGET_APPDIR}/runtime/compat"
    if [ ! -e "${compat}/lib64" ] && [ -d "${compat}/usr/lib64" ]; then
      ln -s "usr/lib64" "${compat}/"
    fi

  apt:
    arch:
      - "{{APPIMAGE_APT_ARCH}}"
    sources:
      - sourceline: deb http://deb.debian.org/debian {{APPIMAGE_APT_DISTRO}} main
        key_url: http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x{{APPIMAGE_APT_PUBKEY}}
      - sourceline: deb http://deb.debian.org/debian {{APPIMAGE_APT_DISTRO}}-updates main
      - sourceline: deb http://deb.debian.org/debian-security/ {{APPIMAGE_APT_DISTRO}}-security main
        key_url: http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x{{APPIMAGE_APT_PUBKEY_SECURITY}}

    include:
      - gir1.2-gtk-3.0
      - gir1.2-rsvg-2.0
      - libbluetooth3
      - libgtk-3-0
      - librsvg2-common
      - libx11-6
      - libxcb1
      - libxext6
      - libxfixes3
      - python3-evdev
      - python3-gi-cairo
      - python3-pylibacl
      - python3-vdf
      - python3-usb1
      - binutils         # required for detection of bluetooth library
      - coreutils        # provides /usr/bin/env
      - shared-mime-info # required for gui if host provides no MIME info, e.g. when XDG_DATA_DIRS is missing

    exclude:
      # coreutils
      - libacl*         # filesystem
      - libattr*        # filesystem
      - libgmp*         # arithmetics

      # gir1.2-rsvg-2.0
      - libicu*         # i18n
      - libstdc*        # development
      - libxml*         # codec

      # libgtk3-0
      - "*-icon-theme"  # gui
      - "*crypt*"       # security
      - "*dconf*"       # gui configuration
      - "*dbus*"        # process communication
      - "*gcc*"         # development
      - "*systemd*"     # linux core
      - libblk*         # filesystem
      - libcolord*      # gui
      - libcups*        # printing
      - libepoxy*       # gui
      - libfontconfig*  # fonts
      - libfreetype*    # fonts
      - libfribidi*     # i18n
      - libgtk-3-common # gui
      - liblz*          # codec
      - libmount*       # filesystem
      - libtiff*        # codec
      - libwebp*        # codec

      # python3
      - "*krb*"         # security
      - "*readline*"    # terminal
      - "*sqlite*"      # database
      - libbz*          # codec
      - libdb*          # database
      - libmpdec*       # arithmetics
      - libncurses*     # terminal
      - libnsl*         # network
      - libssl*         # security
      - libtirpc*       # development
      - libuuid*        # development
      - media-types     # codec

      # Debian Trixie
      - libgprofng*     # development
      - libjansson*     # codec
      - libsframe*      # development
      - libcloudproviders* # networking
      - netbase         # network
      - tzdata          # date/time

  files:
    exclude:
      - usr/bin/*gold*              # alternative for ld
      - usr/bin/*gp-display-html*   # requires perl
      - usr/lib/*/gconv             # unicode
      - usr/lib/*/gdk-pixbuf-2.0/*/loaders/libpixbufloader-??[!g].so # only png & svg are required
      - usr/lib/*/glib-2.0
      - usr/lib/python*/cgi.py
      - usr/lib/python*/email
      - usr/lib/python*/test
      - usr/lib/python*/unittest
      - usr/share/doc
      - usr/share/glib-2.0
      - usr/share/gtk-doc
      - usr/share/icu
      - usr/share/locale
      - usr/share/man
      - usr/share/python3/runtime.d
      - usr/share/thumbnailers

  runtime:
    env:
      # `usr/lib/python3.*/site-packages` is required in $PYTHONPATH,
      # but the python version and hence the actual location is unknown here.
      # Fortunately the site-packages directory is on the $PATH, so we add $PATH instead.
      # It must precede an existing $PYTHONPATH to work.
      PYTHONPATH: "${APPDIR}/usr/lib/python3/dist-packages:${PATH}:${PYTHONPATH}"
      SCC_SHARED: "${APPDIR}/usr/share/scc"

AppImage:
  arch: "{{APPIMAGE_ARCH}}"
  update-information: "gh-releases-zsync|C0rn3j|sc-controller|latest|sc-controller-*-{{APPIMAGE_APT_DISTRO}}-{{APPIMAGE_ARCH}}.AppImage.zsync"
